<%- include('layout', { body: `
<div class="compare-page">
  <div class="compare-actions-bar">
    <a href="javascript:history.back()" class="back-link">&larr; Back to results</a>
    <a href="/pdf/compare?ids=${plans.map(p => p.plan_id).join(',')}" class="btn btn-secondary btn-small" target="_blank">Export PDF</a>
  </div>

  <h1>Compare Plans</h1>

  <div class="compare-cards">
    ${plans.map(p => {
      const formatMoney = (val) => {
        if (!val) return 'N/A';
        if (typeof val === 'string') {
          const cleaned = val.replace(/[$,]/g, '').trim();
          const num = parseFloat(cleaned);
          if (!isNaN(num)) {
            return '$' + Math.round(num).toLocaleString();
          }
          return val;
        }
        return '$' + Number(val).toLocaleString();
      };
      return `
      <div class="compare-plan-card">
        <div class="compare-plan-header ${(p.metal_level || '').toLowerCase().replace(' ', '-')}">
          <span class="metal-pill ${(p.metal_level || '').toLowerCase().replace(' ', '-')}">${p.metal_level || 'N/A'}</span>
          <h3>${p.plan_marketing_name || 'Unnamed Plan'}</h3>
          <p class="issuer">${p.issuer_name || 'Unknown Issuer'}</p>
        </div>
        <div class="compare-plan-body">
          <div class="compare-plan-row">
            <span class="label">Plan Type</span>
            <span class="value"><span class="plan-type-pill ${(p.plan_type || '').toLowerCase()}">${p.plan_type || 'N/A'}</span></span>
          </div>
          <div class="compare-plan-row">
            <span class="label">Deductible (Individual)</span>
            <span class="value">${formatMoney(p.medical_deductible_individual)}</span>
          </div>
          <div class="compare-plan-row">
            <span class="label">Deductible (Family)</span>
            <span class="value">${formatMoney(p.medical_deductible_family)}</span>
          </div>
          <div class="compare-plan-row">
            <span class="label">Out-of-Pocket Max (Individual)</span>
            <span class="value">${formatMoney(p.medical_moop_individual)}</span>
          </div>
          <div class="compare-plan-row">
            <span class="label">Out-of-Pocket Max (Family)</span>
            <span class="value">${formatMoney(p.medical_moop_family)}</span>
          </div>
          <div class="compare-plan-row">
            <span class="label">Drug Deductible</span>
            <span class="value">${formatMoney(p.drug_deductible_individual)}</span>
          </div>
          <div class="compare-plan-row">
            <span class="label">HSA Eligible</span>
            <span class="value">${p.hsa_eligible ? '<span class="hsa-yes">Yes</span>' : 'No'}</span>
          </div>
        </div>
      </div>
    `}).join('')}
  </div>

  ${allBenefits.length > 0 ? `
  <div class="compare-section">
    <h2>Benefits Comparison</h2>
    <div class="compare-table-wrapper">
      <table class="compare-table">
        <thead>
          <tr>
            <th class="benefit-name-col">Benefit</th>
            ${plans.map(p => `<th class="plan-col">${p.plan_marketing_name || 'Plan'}</th>`).join('')}
          </tr>
        </thead>
        <tbody>
          ${allBenefits.slice(0, 30).map(benefitName => `
            <tr>
              <td class="benefit-name">${benefitName}</td>
              ${plans.map(p => {
                const benefit = (benefitsMap[p.plan_id] || []).find(b => b.benefit_name === benefitName);
                if (!benefit) return '<td class="not-covered">-</td>';
                const copay = benefit.copay_in_network || '';
                const coins = benefit.coinsurance_in_network || '';
                const display = [copay, coins].filter(Boolean).join(' / ') || 'Covered';
                return '<td>' + display + '</td>';
              }).join('')}
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  </div>
  ` : ''}
</div>
`}) %>
